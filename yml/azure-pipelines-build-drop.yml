# .azure-pipelines/ci.yml  (or place at repo root as azure-pipelines.yml)
trigger:
  branches:
    include:
      - main
  paths:
    include:
      - app/**
      - app-tests/**
      - azure-pipelines.yml
      - .azure-pipelines/**

pr:
  branches:
    include:
      - main

variables:
  BuildConfiguration: 'Release'
  DotNetVersion: '8.0.x'

pool:
  vmImage: 'windows-latest' # swap to your self-hosted pool if you have one

steps:
- checkout: self
  fetchDepth: 0

- task: UseDotNet@2
  displayName: 'Use .NET SDK $(DotNetVersion)'
  inputs:
    packageType: 'sdk'
    version: '$(DotNetVersion)'

# Optional but recommended: cache NuGet packages
- task: Cache@2
  displayName: 'Cache NuGet packages'
  inputs:
    key: 'nuget | "$(Agent.OS)" | **/*.sln'
    restoreKeys: |
      nuget | "$(Agent.OS)"
      nuget
    path: $(NUGET_PACKAGES)
  continueOnError: true

- script: dotnet restore
  displayName: 'Restore'

- script: dotnet build app/app.csproj -c $(BuildConfiguration) --no-restore
  displayName: 'Build'

# Run tests with trx + code coverage
- script: >
    dotnet test app-tests/app-tests.csproj
    -c $(BuildConfiguration)
    --no-build
    --logger "trx"
    --collect "XPlat Code Coverage"
  displayName: 'Test (with coverage)'

# Publish test results (TRX)
- task: PublishTestResults@2
  displayName: 'Publish test results'
  inputs:
    testResultsFormat: 'VSTest'
    testResultsFiles: '**/*.trx'
    searchFolder: '$(System.DefaultWorkingDirectory)'
    testRunTitle: 'Unit Tests'
    failTaskOnFailedTests: true

# Find and publish coverage (Cobertura)
- powershell: |
    $cobertura = Get-ChildItem -Recurse -Filter "coverage.cobertura.xml" | Select-Object -First 1
    if (-not $cobertura) { Write-Host "No coverage.cobertura.xml found"; exit 0 }
    Write-Host "##vso[task.setvariable variable=CoberturaPath]$($cobertura.FullName)"
  displayName: 'Locate coverage report'

- task: PublishCodeCoverageResults@2
  displayName: 'Publish code coverage'
  condition: and(succeeded(), ne(variables['CoberturaPath'], ''))
  inputs:
    codeCoverageTool: 'Cobertura'
    summaryFileLocation: '$(CoberturaPath)'
    reportDirectory: '$(System.DefaultWorkingDirectory)'

# Produce a publishable artifact of the web app
- script: >
    dotnet publish app/app.csproj
    -c $(BuildConfiguration)
    -o $(Build.ArtifactStagingDirectory)/webapp
  displayName: 'Publish web app'

- task: PublishBuildArtifacts@1
  displayName: 'Publish artifact'
  inputs:
    pathToPublish: '$(Build.ArtifactStagingDirectory)'
    artifactName: 'drop'

